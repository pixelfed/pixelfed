version: '3.7'

# In order to set configuration, please use a .env file in
# your compose project directory (the same directory as your
# docker-compose.yml), and set database options, application
# name, key, and other settings there.
# A list of available settings is available in .env.example
#
# The services should scale properly across a swarm cluster
# if the volumes are properly shared between cluster members.
#
# Run with `docker-compose --env-file=.env.docker up`
#
# Comment the `build` property in the `pixelfed` and `pixelfed_worker`
# services to use the official Pixelfed image on Docker Hub, when that
# becomes available.

networks:
  external:
    driver: bridge
    name: external
  pixelfed:
    driver: bridge
    internal: true
    name: pixelfed

services:
  # App (https://github.com/pixelfed/pixelfed)
  pixelfed:
    build:
      context: .
      dockerfile: contrib/docker/Dockerfile.apache
    container_name: pixelfed
    depends_on:
      pixelfed_db:
        condition: service_healthy
      redis:
        condition: service_started
    env_file: .env.docker
    image: pixelfed/pixelfed:latest
    networks:
      - external
      - pixelfed
    ports:
      - 8080:80
    restart: unless-stopped
    volumes:
      - pixelfed_storage:/var/www/storage
      - pixelfed_bootstrap:/var/www/bootstrap
      - ./.env.docker:/var/www/.env

  # Worker (https://github.com/pixelfed/pixelfed)
  pixelfed_worker:
    build:
      context: .
      dockerfile: contrib/docker/Dockerfile.apache
    container_name: pixelfed_worker
    depends_on:
      pixelfed:
        condition: service_started
      pixelfed_db:
        condition: service_healthy
      redis:
        condition: service_started
    command: gosu www-data php artisan horizon
    env_file: .env.docker
    image: pixelfed/pixelfed:latest
    networks:
      - pixelfed
    restart: unless-stopped
    volumes:
      - pixelfed_storage:/var/www/storage
      - pixelfed_bootstrap:/var/www/bootstrap

  # DB (https://hub.docker.com/_/mariadb)
  pixelfed_db:
    command:
      - --default-authentication-plugin=mysql_native_password
      - --log-bin=false # https://mariadb.com/kb/en/replication-and-binary-log-system-variables/#log_bin
      - --log-warnings=1 # To disable "Access denied" errors from `healthcheck`
    container_name: pixelfed_db
    env_file: .env.docker
    environment:
      - MYSQL_DATABASE=${DB_DATABASE}
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_RANDOM_ROOT_PASSWORD=true
    healthcheck:
      # https://github.com/MariaDB/mariadb-docker/blob/45bb36b2292191a93d2b7a0a4d0eafaa554ba8d5/10.10/healthcheck.sh
      test: [ CMD, /usr/local/bin/healthcheck.sh, --connect ]
      interval: 5s
      timeout: 5s
      retries: 4
      start_period: 10s
    image: mariadb:10.10
    networks:
      - pixelfed
    restart: unless-stopped
    volumes:
      - pixelfed_db:/var/lib/mysql

  # Cache (https://hub.docker.com/_/redis)
  redis:
    command:
      - --requirepass ${REDIS_PASSWORD}
    container_name: redis
    env_file: .env.docker
    image: redis:7.0
    networks:
      - pixelfed
    restart: unless-stopped
    volumes:
      - pixelfed_redis:/data

volumes:
  pixelfed_bootstrap:
  pixelfed_db:
  pixelfed_redis:
  pixelfed_storage:
